(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{194:function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return m}));var n=i(0),a=i.n(n);function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){s(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function o(e,t){if(null==e)return{};var i,n,a=function(e,t){if(null==e)return{};var i,n,a={},s=Object.keys(e);for(n=0;n<s.length;n++)i=s[n],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)i=s[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var c=a.a.createContext({}),d=function(e){var t=a.a.useContext(c),i=t;return e&&(i="function"==typeof e?e(t):r(r({},t),e)),i},b=function(e){var t=d(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},h=a.a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,s=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),b=d(i),h=n,m=b["".concat(l,".").concat(h)]||b[h]||p[h]||s;return i?a.a.createElement(m,r(r({ref:t},c),{},{components:i})):a.a.createElement(m,r({ref:t},c))}));function m(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=i.length,l=new Array(s);l[0]=h;var r={};for(var o in t)hasOwnProperty.call(t,o)&&(r[o]=t[o]);r.originalType=e,r.mdxType="string"==typeof e?e:n,l[1]=r;for(var c=2;c<s;c++)l[c]=i[c];return a.a.createElement.apply(null,l)}return a.a.createElement.apply(null,i)}h.displayName="MDXCreateElement"},92:function(e,t,i){"use strict";i.r(t),i.d(t,"frontMatter",(function(){return l})),i.d(t,"metadata",(function(){return r})),i.d(t,"toc",(function(){return o})),i.d(t,"default",(function(){return d}));var n=i(3),a=i(7),s=(i(0),i(194)),l={id:"add_distro",title:"Adding a New Linux Distribution to Netkit-JH",sidebar_label:"Add a Distro"},r={unversionedId:"dev/guides/add_distro",id:"version-1.1.3/dev/guides/add_distro",isDocsHomePage:!1,title:"Adding a New Linux Distribution to Netkit-JH",description:"Download this Repo",source:"@site/versioned_docs/version-1.1.3/dev/guides/newdistro.md",slug:"/dev/guides/add_distro",permalink:"/docs/dev/guides/add_distro",editUrl:"https://github.com/netkit-jh/netkit-jh.github.io/edit/main/versioned_docs/version-1.1.3/dev/guides/newdistro.md",version:"1.1.3",sidebar_label:"Add a Distro",sidebar:"version-1.1.3/docsSidebar",previous:{title:"Installing Additional Packages",permalink:"/docs/dev/guides/fspackages"},next:{title:"Creating Kernel Patches",permalink:"/docs/dev/guides/kernelpatches"}},o=[{value:"Download this Repo",id:"download-this-repo",children:[]},{value:"Adding a Distro",id:"adding-a-distro",children:[{value:"Filesystem Tweaks",id:"filesystem-tweaks",children:[]},{value:"Bootstrap",id:"bootstrap",children:[]},{value:"Custom Install Scripts",id:"custom-install-scripts",children:[]},{value:"Package Selections",id:"package-selections",children:[]},{value:"Systemd Services",id:"systemd-services",children:[]},{value:"Distro Config",id:"distro-config",children:[]}]},{value:"Build the New Filesystem",id:"build-the-new-filesystem",children:[]},{value:"Test the New Filesystem",id:"test-the-new-filesystem",children:[]}],c={toc:o};function d(e){var t=e.components,i=Object(a.a)(e,["components"]);return Object(s.b)("wrapper",Object(n.a)({},c,i,{components:t,mdxType:"MDXLayout"}),Object(s.b)("h2",{id:"download-this-repo"},"Download this Repo"),Object(s.b)("p",null,"To get a local copy of this repo on the vm run:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"$ git clone https://github.com/netkit-jh/netkit-jh-build.git\n$ cd netkit-jh-build\n$ git checkout multi-distro\n")),Object(s.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"The multi-distro feature is in progress, you will need to use the multi-distro branch.\nThere is currently no method of specifying a filesystem with a netkit lab, it just uses the one at $NETKIT_HOME/fs/netkit-fs. This guide is currently just for testing and experimenting."))),Object(s.b)("h2",{id:"adding-a-distro"},"Adding a Distro"),Object(s.b)("p",null,"To add a distro, first create a directory in the ",Object(s.b)("inlineCode",{parentName:"p"},"distros")," directory, with the name of the new distro. For example if I wanted to add Arch Linux, I might name the directory 'arch'."),Object(s.b)("p",null,"Within this directory you will need:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"A directory called ",Object(s.b)("inlineCode",{parentName:"li"},"filesystem-tweaks")," (Optional)"),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"bootstrap.sh")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"pre-install-netkit-fs.sh")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"post-install-netkit-fs.sh")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"packages-list")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"enabled-services")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"disabled-services")),Object(s.b)("li",{parentName:"ul"},"A file called ",Object(s.b)("inlineCode",{parentName:"li"},"distro.env"))),Object(s.b)("p",null,"If any of the files are missing, the build will not work. If the filesystem-tweaks directory is missing it will be created during the build process."),Object(s.b)("p",null,"An easy way to start is by copying the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/netkit-jh/netkit-jh-build/tree/multi-distro/fs/distros/template"}),"template")," directory."),Object(s.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"Netkit-JH uses systemd in the current distros. It is recommended but not required that any distros you add also use systemd. If not you will probably need to make a lot more distro filesystem-tweaks!"))),Object(s.b)("h3",{id:"filesystem-tweaks"},"Filesystem Tweaks"),Object(s.b)("p",null,Object(s.b)("inlineCode",{parentName:"p"},"filesystem-tweaks")," allows you to create files which will end up in the final filesystem image, with ",Object(s.b)("inlineCode",{parentName:"p"},"filesystem-tweaks/")," representing ",Object(s.b)("inlineCode",{parentName:"p"},"/"),". For example, you might want to add a config file to ",Object(s.b)("inlineCode",{parentName:"p"},"/etc/test.conf"),", so you would place the file at ",Object(s.b)("inlineCode",{parentName:"p"},"filesystem-tweaks/etc/test.conf"),"."),Object(s.b)("p",null,"There are global and per-distro filesystem tweaks. To add a file for all distros, place the file within\n",Object(s.b)("inlineCode",{parentName:"p"},"netkit-jh-build/fs/filesystem-tweaks/..."),", or to add a file for a specific distro, place it within\n",Object(s.b)("inlineCode",{parentName:"p"},"netkit-jh-build/fs/distros/DISTRO/filesystem-tweaks/..."),". The global changes are applied first then the\ndistro specific changes (this will overwrite global tweaks)."),Object(s.b)("h3",{id:"bootstrap"},"Bootstrap"),Object(s.b)("p",null,"The file ",Object(s.b)("inlineCode",{parentName:"p"},"netkit-jh-build/fs/distros/DISTRO/bootstrap.sh")," needs to be a script that will bootstrap (build the base filesystem) for the distro. This can use tools like pacstrap, debootstrap, multistrap etc."),Object(s.b)("p",null,Object(s.b)("inlineCode",{parentName:"p"},"bootstrap.sh")," will be called with the following arguments:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"$1 - the mount directory (the path to where you should install the base OS)"),Object(s.b)("li",{parentName:"ul"},"$2 - the distro directory (the path to ",Object(s.b)("inlineCode",{parentName:"li"},"netkit-jh-build/fs/distros/DISTRO"),")")),Object(s.b)("p",null,"Configuration options can be placed directly in the script but it is recommended to place them in ",Object(s.b)("inlineCode",{parentName:"p"},"distro.env"),", and then source this in the bootstrap script. This means you can then easily change things such as distro release and mirrors from the ",Object(s.b)("inlineCode",{parentName:"p"},"distro.env")," file."),Object(s.b)("h3",{id:"custom-install-scripts"},"Custom Install Scripts"),Object(s.b)("p",null,"The script ",Object(s.b)("inlineCode",{parentName:"p"},"pre-install-netkit-fs.sh")," is run before the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/netkit-jh/netkit-jh-build/blob/multi-distro/fs/install-netkit-fs.sh"}),"global install script")," and ",Object(s.b)("inlineCode",{parentName:"p"},"post-install-netkit-fs.sh")," is run afterwards."),Object(s.b)("p",null,"The main (shared) install script contains key installation steps including:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"installing packages from the packages-list"),Object(s.b)("li",{parentName:"ul"},"copying the filesystem-tweaks to the filesystem"),Object(s.b)("li",{parentName:"ul"},"setting up netkit specific services"),Object(s.b)("li",{parentName:"ul"},"copying in kernel modules"),Object(s.b)("li",{parentName:"ul"},"enabling and disabling systemd services")),Object(s.b)("p",null,"When deciding whether to put commands in the pre or the post install script, you should consider how the above operations would be affected by / would affect the commands."),Object(s.b)("p",null,"These scripts are called with the following arguments:"),Object(s.b)("ul",null,Object(s.b)("li",{parentName:"ul"},"$1 - the work directory netkit-jh-build/fs (which contains global filesystem tweaks)"),Object(s.b)("li",{parentName:"ul"},"$2 - the build directory (which contains the filesystem version file)"),Object(s.b)("li",{parentName:"ul"},"$3 - the mount directory (where the filesystem is mounted)"),Object(s.b)("li",{parentName:"ul"},"$4 - the kernel modules directory (where the built kernel modules are)"),Object(s.b)("li",{parentName:"ul"},"$5 - the distro directory (the path to the distro files - netkit-jh/fs/distros/DISTRO)")),Object(s.b)("h3",{id:"package-selections"},"Package Selections"),Object(s.b)("p",null,"The file ",Object(s.b)("inlineCode",{parentName:"p"},"packages-list")," should contain a list of packages to be installed in the main install script."),Object(s.b)("p",null,"When adding a package make sure the repository is enabled / added to the filesystem - it may be necessary to add to the ",Object(s.b)("inlineCode",{parentName:"p"},"pre-install-netkit-fs.sh")," script to add repos."),Object(s.b)("h3",{id:"systemd-services"},"Systemd Services"),Object(s.b)("p",null,"The file ",Object(s.b)("inlineCode",{parentName:"p"},"enabled-services")," should contain a list of services to enable, and ",Object(s.b)("inlineCode",{parentName:"p"},"disabled-services")," should contain a list of services to disable - quite self explanatory :)"),Object(s.b)("p",null,"You should consider disabling services that may be enabled by the packages you install - as we want to keep netkit machines lightweight, it is better to enable a service in a ",Object(s.b)("inlineCode",{parentName:"p"},".startup")," file rather than have it enabled by default if its not going to be needed by the majority of netkit machines."),Object(s.b)("h3",{id:"distro-config"},"Distro Config"),Object(s.b)("p",null,Object(s.b)("inlineCode",{parentName:"p"},"distro.env")," MUST contain a variable INSTALL_COMMAND which should be set to the command to install a package on a distro.\nDuring the main install script, the packages list will be looped through and for each package, it will run ",Object(s.b)("inlineCode",{parentName:"p"},"$INSTALL_COMMAND packageN"),"."),Object(s.b)("p",null,"You can also include other variables that may be useful in installation scripts - for example you might want to have variables for the distro release and mirror used in ",Object(s.b)("inlineCode",{parentName:"p"},"bootstrap.sh"),". This makes ",Object(s.b)("inlineCode",{parentName:"p"},"distro.env")," into a config file of sorts, meaning it is cleaner and easier to make changes as its all in one place."),Object(s.b)("h2",{id:"build-the-new-filesystem"},"Build the New Filesystem"),Object(s.b)("p",null,"Build the filesystem as shown in the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"dockerbuild"}),"docker")," or ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"debianbuild"}),"vm")," guide, depending on your development environment.\nWhen finished, the filesystem should appear as a tarfile in the root of the netkit-jh-build directory, with a name similar to netkit-fs-0.1.8.tar.bz2 (but with a different version number)."),Object(s.b)("p",null,"You will need to specify the distro you want to build in the make command, otherwise it will default to debian. The DISTRO name must match the directory name created in 'distros'."),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"$ sudo make build-fs distro=DISTRO\n")),Object(s.b)("p",null,"or if using ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"dockerbuild"}),"docker")," to build, make sure to give the environment flag with the make arguments: ",Object(s.b)("inlineCode",{parentName:"p"},'-e MAKE_ARGS="build-fs distro=DISTRO'),"."),Object(s.b)("h2",{id:"test-the-new-filesystem"},"Test the New Filesystem"),Object(s.b)("p",null,"Extract the filesystem to a different location to your main install (you don't want to override the filesystem in $NETKIT_HOME in case there are problems with the filesystem!)."),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"$ mkdir nk_test\n$ cd nk_test\n$ tar -xvf netkit-fs-0.1.8.tar.bz2\n$ ls -lha $NETKIT_HOME/fs # take note of where the symbolic link netkit-fs points to\n$ ln -sfn netkit-ng/fs/netkit-fs-0.1.8 $NETKIT_HOME/fs/netkit-fs\n")),Object(s.b)("p",null,"Now you can run a Netkit lab and test if your software package has been installed on the filesystem."),Object(s.b)("p",null,"After testing, you might want to revert to using the original netkit filesystem that was installed by default.\nTo do this simply change the symbolic link back with:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"$ ln -sfn $NETKIT_HOME/fs/netkit-fs-0.1.8 $NETKIT_HOME/fs/netkit-fs\n")),Object(s.b)("div",{className:"admonition admonition-info alert alert--info"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"Replace the ",Object(s.b)("inlineCode",{parentName:"p"},"$NETKIT_HOME/fs/netkit-fs-0.1.8")," in the last command with the file which was originally pointed to by the symbolic link"))))}d.isMDXComponent=!0}}]);